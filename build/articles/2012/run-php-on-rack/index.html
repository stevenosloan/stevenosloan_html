
<!DOCTYPE html>
<html>
  <head>
    <meta charset='UTF-8' />
    <meta content='width=device-width, initial-scale=1' name='viewport' />
    <meta content='IE=Edge,chrome=1' http-equiv='X-UA-Compatible' />
    <meta content='7KgHTNkMMzdgvgz_Jbb_uNkC18FuunUTvC7MxXWRVRo' name='google-site-verification' />
    <link href='/feed.xml' rel='alternate' title='Steven Sloan | Designer &amp; Developer' type='application/rss+xml' />
    <title>A Method for Using PHP with Middleman | Steven Sloan</title>
    <link href="/assets/css/site-f23fd811.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/assets/scripts/init-67cf6598.js" type="text/javascript"></script>
    <script type='text/javascript'>
      Modernizr.load([ ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js']);
      
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-9014377-1']);
      _gaq.push(['_trackPageview']);
      _gaq.push(['_trackPageLoadTime']);
    </script>
    
  </head>
  <body class='page-articles/2012/run-php-on-rack'>
    <header class='site-navi'>
      <a class='site-title' href='/'>
        <h1>Steven Sloan</h1>
      </a>
      <nav>
        <a class='is-here' href='#anchor-articles'>articles</a>
        <a class='' href='/#anchor-contact'>contact</a>
      </nav>
    </header>
    <section class='content'>
      <nav class='post-nav'>
  <a href='/'>Back</a>
</nav>
<article class='post'>
  <hgroup>
    <h1 class='title'>A Method for Using PHP with Middleman</h1>
    <p class='body'>Oct 20, 2012</p>
  </hgroup>
  <div class='post-content'>
    <div class="notice">
    Admitedly this is a bit of a hack, look for a cleaner method in the future.
</div>

<p>We can&#39;t <em>always</em> use the new shiny toys, and sometimes the new toys even need to play nice with the old dusty ones. This happens even more often (it seems) when using a ruby static site generator (be it <a href="https://github.com/blahed/frank">frank</a>, <a href="http://middlemanapp.com/">middleman</a>, <a href="http://nestacms.com/">nesta</a>, whatever), the intended purpose is to generate static .html files and deploy them to be served via ngnix, apache, w/e - but sometimes we need at least a <em>little</em> bit of server side code to be run, like on contact forms, and PHP is the most ubiquitous/cheap tech to do that with.</p>

<p>I&#39;ll walk through my process of getting PHP to play nice with <a href="http://middlemanapp.com">middleman</a>, so YMMV on other generators but the principles should be the same.</p>

<h2>Setting things up</h2>

<p>As always, a couple things are required to get started.</p>

<ul>
<li>Add <a href="https://github.com/eric1234/rack-legacy">rack-legacy</a> and <a href="https://github.com/jtrupiano/rack-rewrite#readme">rack-rewrite</a> to your gemfile and install them</li>
<li>Install php with the cgi extension, <a href="https://github.com/josegonzalez/homebrew-php">this homebrew formula</a> makes it easy</li>
</ul>

<pre><code>## ./config.rb
unless self.build?

    source_dir = File.join( Dir.pwd, &#39;source&#39; )
    build_dir = File.join( Dir.pwd, &#39;build&#39; )

    require &#39;rack&#39;
    require &#39;rack-legacy&#39;
    require &#39;rack-rewrite&#39;

    use Rack::Rewrite do
      rewrite %r{(.*/$)}, lambda {|match, rack_env|

        ## if the file exists in source, serve it
        if File.exists?( File.join( source_dir, rack_env[&#39;PATH_INFO&#39;], &#39;index.php&#39; ) )
          return File.join( &#39;source&#39;, rack_env[&#39;PATH_INFO&#39;] + &#39;index.php&#39; )

        ## else if it only exists in build, build it
        elsif File.exists?( File.join( build_dir, rack_env[&#39;PATH_INFO&#39;], &#39;index.php&#39; ) )

            ## remove the leading &#39;/&#39; from name
            file = File.join( rack_env[&#39;PATH_INFO&#39;], &#39;index.php&#39; )
            file[0] = &quot;&quot;

            ## build the requested file
            puts &quot;building: #{File.join( &#39;build&#39;, rack_env[&#39;PATH_INFO&#39;], &#39;index.php&#39; )}&quot;
            %x[ middleman build -g #{file} ]

            ## pass the path on
            return File.join( &#39;build&#39;, rack_env[&#39;PATH_INFO&#39;], &#39;index.php&#39; )

        ## else it&#39;s an html file, so pass that on
        else
            return rack_env[&#39;PATH_INFO&#39;]
        end
      }

    end

    use Rack::Legacy::Php, Dir.pwd

end
</code></pre>

<p>Basic flow here is saying: If the .php file is in the source - use that. Otherwise look for a php file in the build directory, if it&#39;s there, build that file and server it. If it&#39;s in neither place, let middleman&#39;s server do its thing.</p>

<p>It&#39;s not ideal as you have to wait for a build to see those pages and at least on this setup (with directory indexes on) it only works with index.php files. Big upside though, those pages making use of php (even the ones using templates) are served with the preview server, and forms/etc can post to them. </p>

<p>I&#39;m definitely looking to improve the process, so look for updates in the future.</p>
  </div>
</article>
    </section>
    <div id='grid'></div>
  </body>
</html>

